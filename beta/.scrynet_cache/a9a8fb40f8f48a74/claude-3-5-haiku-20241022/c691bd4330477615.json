{
  "stage": "annotation",
  "file": "WebGoat/src/main/java/org/owasp/webgoat/webwolf/FileServer.java",
  "prompt": "You are a secure coding expert providing feedback in a code review. Your task is to create an annotated code snippet for a specific security finding.\n\nSECURITY FINDING:\n- File: WebGoat/src/main/java/org/owasp/webgoat/webwolf/FileServer.java\n- Line: 50\n- Description: Potential Path Traversal Vulnerability in File Upload\n- Recommendation: Implement strict filename validation and sanitization before resolving file paths. Ensure the filename cannot contain directory traversal characters like '../' and validate that the resolved path is within the intended directory.\n\nFULL CODE CONTENT:\n/*\n * SPDX-FileCopyrightText: Copyright \u00a9 2017 WebGoat authors\n * SPDX-License-Identifier: GPL-2.0-or-later\n */\npackage org.owasp.webgoat.webwolf;\n\nimport static java.util.Comparator.comparing;\nimport static org.springframework.http.MediaType.ALL_VALUE;\n\nimport jakarta.servlet.http.HttpServletRequest;\nimport java.io.File;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.nio.file.Files;\nimport java.nio.file.attribute.FileTime;\nimport java.time.ZonedDateTime;\nimport java.time.format.DateTimeFormatter;\nimport java.util.ArrayList;\nimport java.util.TimeZone;\nimport lombok.extern.slf4j.Slf4j;\nimport org.apache.commons.io.FileUtils;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.http.MediaType;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.stereotype.Controller;\nimport org.springframework.ui.ModelMap;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.ResponseBody;\nimport org.springframework.web.multipart.MultipartFile;\nimport org.springframework.web.servlet.ModelAndView;\nimport org.springframework.web.servlet.view.RedirectView;\n\n/** Controller for uploading a file */\n@Controller\n@Slf4j\npublic class FileServer {\n\n  private static final DateTimeFormatter dateTimeFormatter =\n      DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\");\n\n  @Value(\"${webwolf.fileserver.location}\")\n  private String fileLocation;\n\n  @Value(\"${server.address}\")\n  private String server;\n\n  @Value(\"${server.servlet.context-path}\")\n  private String contextPath;\n\n  @Value(\"${server.port}\")\n  private int port;\n\n  @RequestMapping(\n      path = \"/file-server-location\",\n      consumes = ALL_VALUE,\n      produces = MediaType.TEXT_PLAIN_VALUE)\n  @ResponseBody\n  public String getFileLocation() {\n    return fileLocation;\n  }\n\n  @PostMapping(value = \"/fileupload\")\n  public ModelAndView importFile(\n      @RequestParam(\"file\") MultipartFile multipartFile, Authentication authentication)\n      throws IOException {\n    var username = authentication.getName();\n    var destinationDir = new File(fileLocation, username);\n    destinationDir.mkdirs();\n    // DO NOT use multipartFile.transferTo(), see\n    // https://stackoverflow.com/questions/60336929/java-nio-file-nosuchfileexception-when-file-transferto-is-called\n    try (InputStream is = multipartFile.getInputStream()) {\n      var destinationFile = destinationDir.toPath().resolve(multipartFile.getOriginalFilename());\n      Files.deleteIfExists(destinationFile);\n      Files.copy(is, destinationFile);\n    }\n    log.debug(\"File saved to {}\", new File(destinationDir, multipartFile.getOriginalFilename()));\n\n    return new ModelAndView(\n        new RedirectView(\"files\", true),\n        new ModelMap().addAttribute(\"uploadSuccess\", \"File uploaded successful\"));\n  }\n\n  @GetMapping(value = \"/files\")\n  public ModelAndView getFiles(\n      HttpServletRequest request, Authentication authentication, TimeZone timezone) {\n    String username = (null != authentication) ? authentication.getName() : \"anonymous\";\n    File destinationDir = new File(fileLocation, username);\n\n    ModelAndView modelAndView = new ModelAndView();\n    modelAndView.setViewName(\"files\");\n    File changeIndicatorFile = new File(destinationDir, username + \"_changed\");\n    if (changeIndicatorFile.exists()) {\n      modelAndView.addObject(\"uploadSuccess\", request.getParameter(\"uploadSuccess\"));\n    }\n    changeIndicatorFile.delete();\n\n    record UploadedFile(String name, String size, String link, String creationTime) {}\n\n    var uploadedFiles = new ArrayList<UploadedFile>();\n    File[] files = destinationDir.listFiles(File::isFile);\n    if (files != null) {\n      for (File file : files) {\n        String size = FileUtils.byteCountToDisplaySize(file.length());\n        String link = String.format(\"files/%s/%s\", username, file.getName());\n        uploadedFiles.add(\n            new UploadedFile(file.getName(), size, link, getCreationTime(timezone, file)));\n      }\n    }\n\n    modelAndView.addObject(\n        \"files\",\n        uploadedFiles.stream().sorted(comparing(UploadedFile::creationTime).reversed()).toList());\n    modelAndView.addObject(\"webwolf_url\", \"http://\" + server + \":\" + port + contextPath);\n    return modelAndView;\n  }\n\n  private String getCreationTime(TimeZone timezone, File file) {\n    try {\n      FileTime creationTime = (FileTime) Files.getAttribute(file.toPath(), \"creationTime\");\n      ZonedDateTime zonedDateTime = creationTime.toInstant().atZone(timezone.toZoneId());\n      return dateTimeFormatter.format(zonedDateTime);\n    } catch (IOException e) {\n      return \"unknown\";\n    }\n  }\n}\n\n\nINSTRUCTIONS:\n1.  Extract a code snippet of 10-15 lines centered around the vulnerable line (50).\n2.  Add a comment directly above the vulnerable line: `// FLAW: [Brief summary of the flaw]`\n3.  Add a comment block directly below the vulnerable line showing the corrected code: `// FIX: \n// [Corrected code line(s)]`\n\nProvide your response in a single, clean JSON object with one key, \"annotated_snippet\". Do not include any text outside the JSON.\nExample format:\n{\n  \"annotated_snippet\": \"public void insecureMethod(String userInput) {\\n    // ... some code ...\\n    // FLAW: This line is vulnerable to SQL Injection.\\n    Statement stmt = conn.createStatement();\\n    ResultSet rs = stmt.executeQuery(\\\"SELECT * FROM users WHERE name = '\" + userInput + \"'\\\");\\n    // FIX:\\n    // PreparedStatement ps = conn.prepareStatement(\\\"SELECT * FROM users WHERE name = ?\\\");\\n    // ps.setString(1, userInput);\\n    // ResultSet rs = ps.executeQuery();\\n    // ... more code ...\\n}\"\n}",
  "raw_response": "{\n  \"annotated_snippet\": \"  @PostMapping(value = \\\"/fileupload\\\")\\n  public ModelAndView importFile(\\n      @RequestParam(\\\"file\\\") MultipartFile multipartFile, Authentication authentication)\\n      throws IOException {\\n    var username = authentication.getName();\\n    var destinationDir = new File(fileLocation, username);\\n    destinationDir.mkdirs();\\n    // DO NOT use multipartFile.transferTo(), see\\n    // https://stackoverflow.com/questions/60336929/java-nio-file-nosuchfileexception-when-file-transferto-is-called\\n    try (InputStream is = multipartFile.getInputStream()) {\\n      // FLAW: Potential path traversal vulnerability by directly using original filename without validation\\n      var destinationFile = destinationDir.toPath().resolve(multipartFile.getOriginalFilename());\\n      // FIX:\\n      // var sanitizedFilename = FilenameUtils.getName(multipartFile.getOriginalFilename());\\n      // var destinationFile = destinationDir.toPath().resolve(sanitizedFilename);\\n      // Validate that destinationFile is within the intended directory\\n      Files.deleteIfExists(destinationFile);\\n      Files.copy(is, destinationFile);\\n    }\\n    log.debug(\\\"File saved to {}\\\", new File(destinationDir, multipartFile.getOriginalFilename()));\"\n}",
  "parsed": {
    "annotated_snippet": "  @PostMapping(value = \"/fileupload\")\n  public ModelAndView importFile(\n      @RequestParam(\"file\") MultipartFile multipartFile, Authentication authentication)\n      throws IOException {\n    var username = authentication.getName();\n    var destinationDir = new File(fileLocation, username);\n    destinationDir.mkdirs();\n    // DO NOT use multipartFile.transferTo(), see\n    // https://stackoverflow.com/questions/60336929/java-nio-file-nosuchfileexception-when-file-transferto-is-called\n    try (InputStream is = multipartFile.getInputStream()) {\n      // FLAW: Potential path traversal vulnerability by directly using original filename without validation\n      var destinationFile = destinationDir.toPath().resolve(multipartFile.getOriginalFilename());\n      // FIX:\n      // var sanitizedFilename = FilenameUtils.getName(multipartFile.getOriginalFilename());\n      // var destinationFile = destinationDir.toPath().resolve(sanitizedFilename);\n      // Validate that destinationFile is within the intended directory\n      Files.deleteIfExists(destinationFile);\n      Files.copy(is, destinationFile);\n    }\n    log.debug(\"File saved to {}\", new File(destinationDir, multipartFile.getOriginalFilename()));"
  },
  "timestamp": "2025-11-16T02:25:53.215778+00:00"
}