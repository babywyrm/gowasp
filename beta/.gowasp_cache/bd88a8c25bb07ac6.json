{
  "stage": "annotation",
  "file": "WebGoat/src/main/java/org/owasp/webgoat/container/MvcConfiguration.java",
  "prompt": "You are a secure coding expert providing feedback in a code review. Your task is to create an annotated code snippet for a specific security finding.\n\nSECURITY FINDING:\n- File: WebGoat/src/main/java/org/owasp/webgoat/container/MvcConfiguration.java\n- Line: 64\n- Description: Potential Template Resource Disclosure via Custom FileTemplateResolver\n- Recommendation: Implement strict validation on resourceName to prevent potential path traversal or unauthorized file access. Add explicit checks to ensure only allowed resource paths are accessible.\n\nFULL CODE CONTENT:\n/*\n * SPDX-FileCopyrightText: Copyright \u00a9 2016 WebGoat authors\n * SPDX-License-Identifier: GPL-2.0-or-later\n */\npackage org.owasp.webgoat.container;\n\nimport java.io.IOException;\nimport java.nio.charset.StandardCharsets;\nimport java.util.Map;\nimport java.util.Set;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.owasp.webgoat.container.i18n.Language;\nimport org.owasp.webgoat.container.i18n.Messages;\nimport org.owasp.webgoat.container.i18n.PluginMessages;\nimport org.owasp.webgoat.container.session.LabelDebugger;\nimport org.springframework.context.ApplicationContext;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.io.ResourceLoader;\nimport org.springframework.core.io.support.ResourcePatternResolver;\nimport org.springframework.web.servlet.LocaleResolver;\nimport org.springframework.web.servlet.ViewResolver;\nimport org.springframework.web.servlet.config.annotation.InterceptorRegistry;\nimport org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;\nimport org.springframework.web.servlet.config.annotation.ViewControllerRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\nimport org.springframework.web.servlet.i18n.LocaleChangeInterceptor;\nimport org.springframework.web.servlet.i18n.SessionLocaleResolver;\nimport org.thymeleaf.IEngineConfiguration;\nimport org.thymeleaf.extras.springsecurity6.dialect.SpringSecurityDialect;\nimport org.thymeleaf.spring6.SpringTemplateEngine;\nimport org.thymeleaf.spring6.templateresolver.SpringResourceTemplateResolver;\nimport org.thymeleaf.spring6.view.ThymeleafViewResolver;\nimport org.thymeleaf.templatemode.TemplateMode;\nimport org.thymeleaf.templateresolver.FileTemplateResolver;\nimport org.thymeleaf.templateresolver.ITemplateResolver;\nimport org.thymeleaf.templateresource.ITemplateResource;\nimport org.thymeleaf.templateresource.StringTemplateResource;\n\n/** Configuration for Spring MVC */\n@Configuration\n@RequiredArgsConstructor\n@Slf4j\npublic class MvcConfiguration implements WebMvcConfigurer {\n\n  private static final String UTF8 = \"UTF-8\";\n\n  private final LessonResourceScanner lessonScanner;\n\n  @Override\n  public void addViewControllers(ViewControllerRegistry registry) {\n    registry.addViewController(\"/login\").setViewName(\"login\");\n    registry.addViewController(\"/lesson_content\").setViewName(\"lesson_content\");\n    registry.addViewController(\"/start.mvc\").setViewName(\"main_new\");\n  }\n\n  @Bean\n  public ViewResolver viewResolver(SpringTemplateEngine thymeleafTemplateEngine) {\n    ThymeleafViewResolver resolver = new ThymeleafViewResolver();\n    resolver.setTemplateEngine(thymeleafTemplateEngine);\n    resolver.setCharacterEncoding(StandardCharsets.UTF_8.displayName());\n    return resolver;\n  }\n\n  /**\n   * Responsible for loading lesson templates based on Thymeleaf, for example:\n   *\n   * <p><div th:include=\"/lessons/spoofcookie/templates/spoofcookieform.html\" id=\"content\"></div>\n   */\n  @Bean\n  public ITemplateResolver lessonThymeleafTemplateResolver(ResourceLoader resourceLoader) {\n    var resolver =\n        new FileTemplateResolver() {\n          @Override\n          protected ITemplateResource computeTemplateResource(\n              IEngineConfiguration configuration,\n              String ownerTemplate,\n              String template,\n              String resourceName,\n              String characterEncoding,\n              Map<String, Object> templateResolutionAttributes) {\n            try (var is =\n                resourceLoader.getResource(\"classpath:\" + resourceName).getInputStream()) {\n              return new StringTemplateResource(\n                  new String(is.readAllBytes(), StandardCharsets.UTF_8));\n            } catch (IOException e) {\n              return null;\n            }\n          }\n        };\n    resolver.setOrder(1);\n    return resolver;\n  }\n\n  /** Loads all normal WebGoat specific Thymeleaf templates */\n  @Bean\n  public ITemplateResolver springThymeleafTemplateResolver(ApplicationContext applicationContext) {\n    SpringResourceTemplateResolver resolver = new SpringResourceTemplateResolver();\n    resolver.setPrefix(\"classpath:/webgoat/templates/\");\n    resolver.setSuffix(\".html\");\n    resolver.setTemplateMode(TemplateMode.HTML);\n    resolver.setOrder(2);\n    resolver.setCharacterEncoding(UTF8);\n    resolver.setApplicationContext(applicationContext);\n    return resolver;\n  }\n\n  /** Loads the html for the complete lesson, see lesson_content.html */\n  @Bean\n  public LessonTemplateResolver lessonTemplateResolver(ResourceLoader resourceLoader) {\n    LessonTemplateResolver resolver = new LessonTemplateResolver(resourceLoader);\n    resolver.setOrder(0);\n    resolver.setCacheable(false);\n    resolver.setCharacterEncoding(UTF8);\n    return resolver;\n  }\n\n  /** Loads the lesson asciidoc. */\n  @Bean\n  public AsciiDoctorTemplateResolver asciiDoctorTemplateResolver(\n      Language language, ResourceLoader resourceLoader) {\n    log.debug(\"template locale {}\", language);\n    AsciiDoctorTemplateResolver resolver =\n        new AsciiDoctorTemplateResolver(language, resourceLoader);\n    resolver.setCacheable(false);\n    resolver.setOrder(1);\n    resolver.setCharacterEncoding(UTF8);\n    return resolver;\n  }\n\n  @Bean\n  public SpringTemplateEngine thymeleafTemplateEngine(\n      ITemplateResolver springThymeleafTemplateResolver,\n      LessonTemplateResolver lessonTemplateResolver,\n      AsciiDoctorTemplateResolver asciiDoctorTemplateResolver,\n      ITemplateResolver lessonThymeleafTemplateResolver) {\n    SpringTemplateEngine engine = new SpringTemplateEngine();\n    engine.setEnableSpringELCompiler(true);\n    engine.addDialect(new SpringSecurityDialect());\n    engine.setTemplateResolvers(\n        Set.of(\n            lessonTemplateResolver,\n            asciiDoctorTemplateResolver,\n            lessonThymeleafTemplateResolver,\n            springThymeleafTemplateResolver));\n    return engine;\n  }\n\n  @Override\n  public void addResourceHandlers(ResourceHandlerRegistry registry) {\n    // WebGoat internal\n    registry.addResourceHandler(\"/css/**\").addResourceLocations(\"classpath:/webgoat/static/css/\");\n    registry.addResourceHandler(\"/js/**\").addResourceLocations(\"classpath:/webgoat/static/js/\");\n    registry\n        .addResourceHandler(\"/plugins/**\")\n        .addResourceLocations(\"classpath:/webgoat/static/plugins/\");\n    registry\n        .addResourceHandler(\"/fonts/**\")\n        .addResourceLocations(\"classpath:/webgoat/static/fonts/\");\n\n    // WebGoat lessons\n    registry\n        .addResourceHandler(\"/images/**\")\n        .addResourceLocations(\n            lessonScanner.applyPattern(\"classpath:/lessons/%s/images/\").toArray(String[]::new));\n    registry\n        .addResourceHandler(\"/lesson_js/**\")\n        .addResourceLocations(\n            lessonScanner.applyPattern(\"classpath:/lessons/%s/js/\").toArray(String[]::new));\n    registry\n        .addResourceHandler(\"/lesson_css/**\")\n        .addResourceLocations(\n            lessonScanner.applyPattern(\"classpath:/lessons/%s/css/\").toArray(String[]::new));\n    registry\n        .addResourceHandler(\"/lesson_templates/**\")\n        .addResourceLocations(\n            lessonScanner.applyPattern(\"classpath:/lessons/%s/templates/\").toArray(String[]::new));\n    registry\n        .addResourceHandler(\"/video/**\")\n        .addResourceLocations(\n            lessonScanner.applyPattern(\"classpath:/lessons/%s/video/\").toArray(String[]::new));\n  }\n\n  @Bean\n  public PluginMessages pluginMessages(\n      Messages messages, Language language, ResourcePatternResolver resourcePatternResolver) {\n    PluginMessages pluginMessages = new PluginMessages(messages, language, resourcePatternResolver);\n    pluginMessages.setDefaultEncoding(\"UTF-8\");\n    pluginMessages.setBasenames(\"i18n/WebGoatLabels\");\n    pluginMessages.setFallbackToSystemLocale(false);\n    return pluginMessages;\n  }\n\n  @Bean\n  public Language language(LocaleResolver localeResolver) {\n    return new Language(localeResolver);\n  }\n\n  @Bean\n  public LocaleResolver localeResolver() {\n    SessionLocaleResolver localeResolver = new SessionLocaleResolver();\n    return localeResolver;\n  }\n\n  @Bean\n  public LocaleChangeInterceptor localeChangeInterceptor() {\n    LocaleChangeInterceptor lci = new LocaleChangeInterceptor();\n    lci.setParamName(\"lang\");\n    return lci;\n  }\n\n  @Override\n  public void addInterceptors(InterceptorRegistry registry) {\n    registry.addInterceptor(localeChangeInterceptor());\n    registry.addInterceptor(new UserInterceptor());\n  }\n\n  @Bean\n  public Messages messageSource(Language language) {\n    Messages messages = new Messages(language);\n    messages.setDefaultEncoding(\"UTF-8\");\n    messages.setBasename(\"classpath:i18n/messages\");\n    messages.setFallbackToSystemLocale(false);\n    return messages;\n  }\n\n  @Bean\n  public LabelDebugger labelDebugger() {\n    return new LabelDebugger();\n  }\n}\n\n\nINSTRUCTIONS:\n1.  Extract a code snippet of 10-15 lines centered around the vulnerable line (64).\n2.  Add a comment directly above the vulnerable line: `// FLAW: [Brief summary of the flaw]`\n3.  Add a comment block directly below the vulnerable line showing the corrected code: `// FIX: \n// [Corrected code line(s)]`\n\nProvide your response in a single, clean JSON object with one key, \"annotated_snippet\". Do not include any text outside the JSON.\nExample format:\n{\n  \"annotated_snippet\": \"public void insecureMethod(String userInput) {\\n    // ... some code ...\\n    // FLAW: This line is vulnerable to SQL Injection.\\n    Statement stmt = conn.createStatement();\\n    ResultSet rs = stmt.executeQuery(\\\"SELECT * FROM users WHERE name = '\" + userInput + \"'\\\");\\n    // FIX:\\n    // PreparedStatement ps = conn.prepareStatement(\\\"SELECT * FROM users WHERE name = ?\\\");\\n    // ps.setString(1, userInput);\\n    // ResultSet rs = ps.executeQuery();\\n    // ... more code ...\\n}\"\n}",
  "raw_response": "{\n  \"annotated_snippet\": \"  @Bean\\n  public ITemplateResolver lessonThymeleafTemplateResolver(ResourceLoader resourceLoader) {\\n    var resolver =\\n        new FileTemplateResolver() {\\n          @Override\\n          protected ITemplateResource computeTemplateResource(\\n              IEngineConfiguration configuration,\\n              String ownerTemplate,\\n              String template,\\n              // FLAW: Potential path traversal and unauthorized file access via unchecked resourceName\\n              String resourceName,\\n              String characterEncoding,\\n              Map<String, Object> templateResolutionAttributes) {\\n            try (var is =\\n                resourceLoader.getResource(\\\"classpath:\\\" + resourceName).getInputStream()) {\\n              return new StringTemplateResource(\\n                  new String(is.readAllBytes(), StandardCharsets.UTF_8));\\n            } catch (IOException e) {\\n              return null;\\n            }\\n          }\\n        };\\n        // FIX:\\n        // String sanitizedResourceName = sanitizeResourcePath(resourceName);\\n        // resourceLoader.getResource(\\\"classpath:\\\" + sanitizedResourceName)\\n        // Add explicit path validation to restrict resource loading\\n    resolver.setOrder(1);\\n    return resolver;\"\n}",
  "parsed": {
    "annotated_snippet": "  @Bean\n  public ITemplateResolver lessonThymeleafTemplateResolver(ResourceLoader resourceLoader) {\n    var resolver =\n        new FileTemplateResolver() {\n          @Override\n          protected ITemplateResource computeTemplateResource(\n              IEngineConfiguration configuration,\n              String ownerTemplate,\n              String template,\n              // FLAW: Potential path traversal and unauthorized file access via unchecked resourceName\n              String resourceName,\n              String characterEncoding,\n              Map<String, Object> templateResolutionAttributes) {\n            try (var is =\n                resourceLoader.getResource(\"classpath:\" + resourceName).getInputStream()) {\n              return new StringTemplateResource(\n                  new String(is.readAllBytes(), StandardCharsets.UTF_8));\n            } catch (IOException e) {\n              return null;\n            }\n          }\n        };\n        // FIX:\n        // String sanitizedResourceName = sanitizeResourcePath(resourceName);\n        // resourceLoader.getResource(\"classpath:\" + sanitizedResourceName)\n        // Add explicit path validation to restrict resource loading\n    resolver.setOrder(1);\n    return resolver;"
  },
  "timestamp": "2025-11-09T19:30:53.804397+00:00"
}